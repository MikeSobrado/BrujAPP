<!-- Sección Inicio -->
<div class="row">
    <div class="col-12">
        <!-- Sistema de pestañas interno FUERA del card -->
        <div class="tabs-card d-flex justify-content-center mb-3">
            <button class="inicio-tab active" data-target="dashboard">
                <i class="bi bi-speedometer2 me-2"></i>Dashboard
            </button>
            <button class="inicio-tab" data-target="graficas">
                <i class="bi bi-graph-up me-2"></i>Gráficas
            </button>
            <button class="inicio-tab" data-target="gestion-riesgo">
                <i class="bi bi-shield-check me-2"></i>Gestión de Riesgo
            </button>
        </div>
        
        <div class="card">
            <div class="card-header">
                <i class="bi bi-house me-2"></i>Crystal Sphere
            </div>
            <div class="card-body">
                <!-- Contenido de las pestañas -->
                <div class="inicio-content">
                    <div class="inicio-pane active" id="dashboard">
                        <div class="decision-header">
                            <div class="decision-title-section">
                                <h5 class="card-title">Panel de Decisión de Trading <i class="bi bi-question-circle" title="Cada indicador tiene un cuadro para una puntuación.&#10;Indica cuantos puntos tiene en la toma de decisiones.&#10;Configúralos siguiendo tu propio criterio y ajústalos&#10;para adaptar tu perfil de trading a medida que ganas&#10;experiencia en el mundillo. También puedes crear&#10;nuevos indicadores a tu gusto o editar los que hay.&#10;Los paneles de decisión tienen su propia puntuación.&#10;Es el mínimo de puntos necesario para que el panel te&#10;sugiera realizar una operación. Según tu estrategia,&#10;necesitarás que haya más indicadores que te indiquen&#10;una posición o la contraria.&#10;Aprenderás a trazar un plan, mantenerte firme y ser&#10;disciplinado."></i></h5>
                                <p class="card-text">
                                    Sistema de señales visuales para tus decisiones de trading. Instrucciones de uso en el interrogante en la línea de arriba.
                                </p>
                            </div>
                        </div>
                
                <!-- Panel de Decisión -->
                    <!-- Panel de Perfiles -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-person-lines-fill me-2"></i>
                                Perfiles de Usuario
                            </h5>
                        </div>
                        <div class="card-body d-flex align-items-center flex-wrap gap-2">
                            <select class="form-select" id="profile-select" style="max-width: 220px;">
                                <option value="default">Perfil por defecto</option>
                                <!-- Opciones de perfiles dinámicas -->
                            </select>
                            <button type="button" class="btn btn-primary" id="add-profile-btn">Agregar</button>
                            <button type="button" class="btn btn-primary" id="rename-profile-btn">Renombrar</button>
                            <button type="button" class="btn btn-primary" id="delete-profile-btn">Eliminar</button>
                            <button type="button" class="btn btn-primary" id="save-profile-btn">Guardar</button>
                            <button type="button" class="btn btn-primary" id="load-profile-btn">Cargar</button>
                        </div>
                    </div>
                    <!-- Panel de Decisión -->
                    <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-lightning-charge me-2"></i>
                            Panel de Decisión Trading
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="decision-panel">
                            <div class="decision-icons-container">
                                <div class="decision-item decision-buy" id="buy-signal">
                                    <svg class="decision-icon" viewBox="0 0 24 24">
                                        <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.85-1.26l3.03-7.08c.09-.23.12-.47.12-.66v-2z"/>
                                    </svg>
                                    <div class="decision-controls">
                                        <span class="decision-label">LONG</span>
                                        <input type="number" class="threshold-input" id="green-threshold" value="40" min="1">
                                    </div>
                                </div>
                                <div class="decision-item decision-wait active" id="wait-signal">
                                    <svg class="decision-icon" viewBox="0 0 24 24">
                                        <path d="M6 2v6h.01L6 8.01 10 12l-4 4 .01.01H6V22h12v-5.99h-.01L18 16l-4-4 4-3.99-.01-.01H18V2H6z"/>
                                    </svg>
                                    <div class="decision-controls">
                                        <span class="decision-label">ESPERA</span>
                                    </div>
                                </div>
                                <div class="decision-item decision-sell" id="sell-signal">
                                    <svg class="decision-icon" viewBox="0 0 24 24">
                                        <path d="M15 3H6c-.83 0-1.54.5-1.85 1.26l-3.03 7.08c-.09.23-.12.47-.12.66v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/>
                                    </svg>
                                    <div class="decision-controls">
                                        <span class="decision-label">SHORT</span>
                                        <input type="number" class="threshold-input" id="red-threshold" value="40" min="1">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel de Indicadores -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up me-2"></i>
                            Indicadores de Trading
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="indicators-panel">
                            <ul class="indicator-list" id="indicator-list">
                                <!-- Los indicadores se cargarán dinámicamente -->
                            </ul>
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-primary" id="add-indicator-btn">
                                    <i class="bi bi-plus-circle me-2"></i>
                                    Añadir Indicador
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    </div>
</div>

<script>
// Configurar validación del formulario demo
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('demo-validator-form');
    if (form && window.ValidatorSystem) {
        setupValidatorDemo();
    }
});

function setupValidatorDemo() {
    const schema = {
        email: {
            rules: ['required', 'email'],
            sanitize: { maxStringLength: 100 }
        },
        amount: {
            rules: ['required', 'numeric', 'positive', { name: 'max', params: [1000000] }],
            sanitize: { maxStringLength: 20 }
        },
        text: {
            rules: [{ name: 'maxLength', params: [500] }],
            sanitize: { 
                maxStringLength: 500,
                sanitizeHtml: true,
                allowedTags: ['b', 'i', 'em', 'strong']
            }
        }
    };

    const form = document.getElementById('demo-validator-form');
    
    // Validación en tiempo real
    ['email', 'amount', 'text'].forEach(fieldName => {
        const field = document.querySelector(`[name="${fieldName}"]`);
        if (field) {
            field.addEventListener('blur', () => validateField(fieldName, field, schema[fieldName]));
            field.addEventListener('input', debounce(() => validateField(fieldName, field, schema[fieldName]), 500));
        }
    });

    // Validación al enviar
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        const validationResult = window.ValidatorSystem.validateApiInput(data, schema);
        
        displayValidationResults(validationResult);
        displaySanitizedData(validationResult.sanitizedData);
        
        // Mostrar errores en campos
        Object.entries(validationResult.data).forEach(([fieldName, result]) => {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (field) {
                if (result.isValid) {
                    field.classList.remove('is-invalid');
                    field.classList.add('is-valid');
                } else {
                    field.classList.remove('is-valid');
                    field.classList.add('is-invalid');
                    const feedback = field.parentNode.querySelector('.invalid-feedback');
                    if (feedback) {
                        feedback.textContent = result.errors.map(e => e.message).join(', ');
                    }
                }
            }
        });
    });
}

function validateField(fieldName, field, fieldSchema) {
    const result = window.ValidatorSystem.processInput(field.value, fieldSchema.rules, fieldSchema.sanitize);
    
    if (result.isValid) {
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
    } else {
        field.classList.remove('is-valid');
        field.classList.add('is-invalid');
        const feedback = field.parentNode.querySelector('.invalid-feedback');
        if (feedback) {
            feedback.textContent = result.errors.map(e => e.message).join(', ');
        }
    }
}

function displayValidationResults(result) {
    const container = document.getElementById('validation-results');
    
    let html = `<div class="alert ${result.isValid ? 'alert-success' : 'alert-danger'}">
        <strong>${result.isValid ? 'Válido' : 'Errores encontrados'}:</strong>
    </div>`;
    
    if (!result.isValid) {
        html += '<ul class="list-group list-group-flush">';
        result.errors.forEach(error => {
            html += `<li class="list-group-item"><strong>${error.field}:</strong> ${error.message}</li>`;
        });
        html += '</ul>';
    }
    
    container.innerHTML = html;
}

function demoRiskValidation() {
    const validators = window.ValidatorSystem.validateTradingData();
    
    // Probar diferentes valores
    const testValues = [
        { value: "1000", label: "Valor válido" },
        { value: "-500", label: "Valor negativo" },
        { value: "abc", label: "No numérico" },
        { value: "", label: "Vacío" }
    ];
    
    let html = '<h6>Demo Risk Calculator Validation:</h6>';
    
    testValues.forEach(test => {
        const result = validators.validateRiskInput(test.value, 0, 100000);
        const statusMessage = result.isValid ? '✅ Válido' : '❌ ' + result.errors.map(e => e.message).join(', ');
        html += `<div class="alert ${result.isValid ? 'alert-success' : 'alert-danger'} py-2">
            <strong>${test.label} (${test.value}):</strong> 
            ${statusMessage}
        </div>`;
    });
    
    document.getElementById('validation-results').innerHTML = html;
}

function demoXSSPrevention() {
    const maliciousInputs = [
        '&lt;script&gt;alert("XSS")&lt;/script&gt;',
        '&lt;img src="x" onerror="alert(XSS)"&gt;',
        '&lt;b&gt;Texto seguro&lt;/b&gt;',
        'javascript:alert("XSS")'
    ];
    
    let html = '<h6>Demo XSS Prevention:</h6>';
    
    maliciousInputs.forEach(input => {
        const sanitized = window.preventXSS(input);
        const htmlSanitized = window.sanitize(input, { 
            allowedTags: ['b', 'i', 'em', 'strong'],
            sanitizeHtml: true 
        });
        
        html += '<div class="card mb-2"><div class="card-body p-2">';
        html += '<strong>Original:</strong> <code>' + input + '</code><br>';
        html += '<strong>XSS Escaped:</strong> <code>' + sanitized + '</code><br>';
        html += '<strong>HTML Sanitized:</strong> <code>' + htmlSanitized + '</code>';
        html += '</div></div>';
    });
    
    document.getElementById('validation-results').innerHTML = html;
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Funciones de demostración del Loading System
function demoGlobalLoading() {
    const loadingId = window.LoadingSystem.showGlobalLoading({
        text: 'Procesando datos...',
        id: 'demo-global'
    });
    
    setTimeout(() => {
        window.LoadingSystem.hideGlobalLoading(loadingId);
        updateLoadingStatus();
    }, 3000);
    
    updateLoadingStatus();
}

function demoProgressLoading() {
    window.LoadingSystem.simulateLoading('demo-progress', 4000, 25);
    updateLoadingStatus();
}

function demoInlineLoading() {
    window.LoadingSystem.showInlineLoading('demo-container', {
        text: 'Cargando contenido...',
        type: 'spinner',
        size: 'large'
    });
    
    setTimeout(() => {
        window.LoadingSystem.hideInlineLoading('demo-container');
        updateLoadingStatus();
    }, 2500);
    
    updateLoadingStatus();
}

function demoButtonLoading(button) {
    const buttonId = button.id || 'btn-demo';
    
    window.LoadingSystem.showButtonLoading(buttonId, 'Procesando...');
    
    setTimeout(() => {
        window.LoadingSystem.hideButtonLoading(buttonId);
        updateLoadingStatus();
    }, 3000);
    
    updateLoadingStatus();
}

function demoSkeletonLoading() {
    window.LoadingSystem.showInlineLoading('demo-container', {
        type: 'skeleton'
    });
    
    setTimeout(() => {
        window.LoadingSystem.hideInlineLoading('demo-container');
        updateLoadingStatus();
    }, 3000);
    
    updateLoadingStatus();
}

function clearAllLoadings() {
    window.LoadingSystem.clearAllLoading();
    updateLoadingStatus();
}

function updateLoadingStatus() {
    const state = window.LoadingSystem.getLoadingState();
    document.getElementById('active-count').textContent = state.globalCount;
    document.getElementById('active-ids').textContent = state.activeLoaders.length > 0 ? state.activeLoaders.join(', ') : 'Ninguno';
}

// Actualizar estado inicial
setTimeout(updateLoadingStatus, 1000);

// Función para mostrar/ocultar demos
function toggleDemoSystems() {
    const section = document.getElementById('demo-systems-section');
    const content = document.getElementById('demo-systems-content');
    const icon = document.getElementById('demo-toggle-icon');
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        content.classList.add('show');
        icon.classList.remove('bi-chevron-down');
        icon.classList.add('bi-chevron-up');
    } else {
        section.style.display = 'none';
        content.classList.remove('show');
        icon.classList.remove('bi-chevron-up');
        icon.classList.add('bi-chevron-down');
    }
}

// Inicializar demos solo en desarrollo
if (window.AppConfig && window.AppConfig.getDemoConfig && window.AppConfig.getDemoConfig('enabled')) {
    document.addEventListener('DOMContentLoaded', function() {
        // Mostrar botón para acceder a demos en desarrollo
        const toggleButton = document.createElement('button');
        toggleButton.className = 'btn btn-outline-info btn-sm position-fixed';
        toggleButton.style.cssText = 'top: 20px; right: 20px; z-index: 1050;';
        toggleButton.innerHTML = '<i class="bi bi-tools"></i> Demos';
        toggleButton.onclick = toggleDemoSystems;
        document.body.appendChild(toggleButton);
    });
}
</script>

                });
}
</script>

                    <!-- Fin de la primera pestaña (dashboard) -->
                    
                    <!-- Segunda pestaña: Gráficas -->
                    <div class="inicio-pane" id="graficas">
                        <h1 style="color: blue; background: lightgreen; padding: 20px; margin: 20px; border: 5px solid purple;">
                            PESTAÑA GRÁFICAS - CONTENIDO DE PRUEBA
                        </h1>
                        <div style="background: lightcyan; height: 200px; width: 100%; border: 3px solid navy; padding: 20px;">
                            <h2>AQUÍ IRÁN LAS GRÁFICAS</h2>
                            <p>Este será el contenido de TradingView y otros gráficos.</p>
                            <button style="background: blue; color: white; padding: 10px; border: none;">Cargar Gráficas</button>
                        </div>
                    </div>
                    
                    <!-- Tercera pestaña: Gestión de Riesgo -->
                    <div class="inicio-pane" id="gestion-riesgo">
                        <h1 style="color: red; background: yellow; padding: 20px; margin: 20px; border: 5px solid blue;">
                            TEST - SI PUEDES LEER ESTO, EL CONTENIDO FUNCIONA
                        </h1>
                        <div style="background: lime; height: 200px; width: 100%; border: 3px solid black; padding: 20px;">
                            <h2>CONTENIDO DE PRUEBA SIMPLE</h2>
                            <p>Este es contenido directo sin clases de Bootstrap.</p>
                            <button style="background: red; color: white; padding: 10px; border: none;">Botón de prueba</button>
                        </div>
                    </div>
                </div> <!-- Fin del contenido de pestañas -->
            </div> <!-- Fin del card-body -->
        </div> <!-- Fin del card -->
    </div> <!-- Fin de la columna -->
</div> <!-- Fin de la fila -->

<script>
// Funciones de demo para el Cache System
function demoCacheBasic() {
    try {
        const key = document.getElementById('cache-key').value || 'test-key';
        const value = document.getElementById('cache-value').value;
        
        let data;
        try {
            data = JSON.parse(value);
        } catch (e) {
            data = value; // Si no es JSON válido, usar como string
        }
        
        // Guardar en cache
        const saved = window.cache.set(key, data);
        
        // Recuperar del cache
        const retrieved = window.cache.get(key);
        
        console.log('Cache Básico:', { key, saved, original: data, retrieved, success: JSON.stringify(data) === JSON.stringify(retrieved) });
        
    } catch (error) {
        console.error('Error en Cache Básico:', error.message);
    }
}

function demoCacheWithExpiration() {
    try {
        const key = document.getElementById('cache-key').value || 'test-expiration';
        const value = document.getElementById('cache-value').value;
        const ttl = parseInt(document.getElementById('cache-ttl').value) || 5000;
        
        let data;
        try {
            data = JSON.parse(value);
        } catch (e) {
            data = value;
        }
        
        // Guardar con expiración
        const saved = window.cache.set(key, data, { maxAge: ttl });
        
        // Recuperar inmediatamente
        const immediate = window.cache.get(key);
        
        console.log('Cache con Expiración:', { key, ttl: `${ttl}ms`, saved, immediate });
        
        // Programar verificación después de expiración
        setTimeout(() => {
            const expired = window.cache.get(key);
            console.log('Verificación Post-Expiración:', { key, expired: expired ? 'Aún existe' : 'null (correcto)' });
        }, ttl + 1000);
        
    } catch (error) {
        console.error('Error en Cache con Expiración:', error.message);
    }
}

async function demoCacheAPI() {
    try {
        console.log('Cache API: Simulando petición...');
        
        // Primera llamada - simular
        const startTime1 = Date.now();
        const mockData = {
            prices: { EURUSD: 1.2345, GBPUSD: 1.5678 },
            timestamp: new Date().toISOString(),
            cached: false
        };
        
        window.cache.set('api-market-data', mockData, { 
            maxAge: 30000, 
            namespace: 'api',
            tags: ['api', 'market'] 
        });
        const time1 = Date.now() - startTime1;
        
        // Segunda llamada
        const startTime2 = Date.now();
        const cachedData = window.cache.get('api-market-data', 'api');
        const time2 = Date.now() - startTime2;
        
        console.log('Cache API:', {
            firstCall: { time: `${time1}ms`, source: 'Simulación API' },
            secondCall: { time: `${time2}ms`, source: 'Cache' },
            speedImprovement: `${Math.round((time1/time2) * 100)}% más rápido`
        });
        
    } catch (error) {
        console.error('Error en Cache API:', error.message);
    }
}

function demoCacheTradingData() {
    try {
        const tradingData = {
            symbol: 'EURUSD',
            bid: 1.2340,
            ask: 1.2342,
            spread: 0.0002,
            timestamp: new Date().toISOString()
        };
        
        const panelConfig = {
            panelId: 'macd-panel',
            indicators: ['MACD', 'RSI'],
            timeframe: '1H',
            alerts: true
        };
        
        window.tradingCache.setMarketData('EURUSD', tradingData);
        window.tradingCache.setPanelConfig('macd-panel', panelConfig);
        
        const retrievedMarket = window.tradingCache.getMarketData('EURUSD');
        const retrievedPanel = window.tradingCache.getPanelConfig('macd-panel');
        
        console.log('Cache Trading:', {
            marketData: { match: JSON.stringify(tradingData) === JSON.stringify(retrievedMarket) },
            panelConfig: { match: JSON.stringify(panelConfig) === JSON.stringify(retrievedPanel) }
        });
        
    } catch (error) {
        console.error('Error en Cache Trading:', error.message);
    }
}

function demoCacheStats() {
    try {
        const stats = window.cache.stats();
        console.log('Estadísticas del Cache:', stats);
        
        // Actualizar display de stats
        const statsDisplay = document.getElementById('cache-stats-display');
        if (statsDisplay) {
            statsDisplay.innerHTML = `
                <div class="mb-2">
                    <strong>Memoria:</strong><br>
                    <small>${stats.memory.entries}/${stats.memory.maxSize} entradas (${stats.memory.usage}%)</small>
                </div>
                <div class="mb-2">
                    <strong>Storage:</strong><br>
                    <small>${stats.storage.entries} entradas (${stats.storage.sizeFormatted})</small>
                </div>
                <div>
                    <strong>Config:</strong><br>
                    <small>TTL: ${stats.config.maxAge/1000}s | Compresión: ${stats.config.compression ? 'Sí' : 'No'}</small>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error en Estadísticas:', error.message);
    }
}

function demoCacheClear() {
    try {
        const statsBefore = window.cache.stats();
        window.cache.clear();
        const statsAfter = window.cache.stats();
        
        console.log('Cache Limpiado:', { before: statsBefore, after: statsAfter });
        
        // Actualizar display
        const statsDisplay = document.getElementById('cache-stats-display');
        if (statsDisplay) {
            statsDisplay.innerHTML = `
                <div class="alert alert-success">
                    <strong>Cache Limpiado</strong><br>
                    <small>Memoria: 0/${statsAfter.memory.maxSize} entradas</small><br>
                    <small>Storage: 0 entradas</small>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error al limpiar cache:', error.message);
    }
}

// Función displayCacheResults comentada temporalmente para evitar errores
/*
function displayCacheResults(result) {
    const container = document.getElementById('cache-results');
    
    let html = `<div class="alert ${result.error ? 'alert-danger' : 'alert-success'}">
        <strong>${result.operation}</strong>
    </div>`;
    
    if (result.error) {
        html += `<div class="text-danger">Error: ${result.error}</div>`;
    } else {
        html += '<div class="row">';
        
        Object.keys(result).forEach(key => {
            if (key !== 'operation' && key !== 'error') {
                const value = result[key];
                html += `<div class="col-md-6 mb-2">
                    <strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong><br>
                    <code>${typeof value === 'object' ? JSON.stringify(value, null, 2) : value}</code>
                </div>`;
            }
        });
        
        html += '</div>';
    }
    
    container.innerHTML = html;
}
*/

// Inicializar estadísticas al cargar
document.addEventListener('DOMContentLoaded', function() {
    if (window.cache && window.cache.stats) {
        setTimeout(demoCacheStats, 500);
    }
});
</script>
                
                </div> <!-- Fin de las demos del Cache System -->
            </div> <!-- Fin del contenido colapsable de demos -->
        </div> <!-- Fin de la tarjeta de demos -->
    </div> <!-- Fin de la columna de demos -->
</div> <!-- Fin de la sección de demos -->