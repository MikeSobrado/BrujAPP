<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrujAPP</title>
    
    <!-- Librería Chart.js para los gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- VARIABLES DE COLOR Y TIPOGRAFÍA --- */
        :root {
            --bg-deep-purple: #0f0c29;
            --panel-purple: #3a2a4a;
            --item-purple: #31263e;
            --text-light: #f0f0f0;
            --text-dim: #b0b0b0;
            --accent-cyan: #00ffff;
            --accent-magenta: #ff00ff;
            --accent-yellow: #ffc107;
            --font-main: 'Poppins', 'Roboto', sans-serif;
        }

        /* --- ESTILOS CSS --- */

        /* Fuentes y colores generales */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        body {
            font-family: var(--font-main);
            background-color: var(--bg-deep-purple);
            color: var(--text-light);
            margin: 0;
            padding: 20px;
        }

        /* --- ESTILOS DEL SISTEMA DE PESTAÑAS --- */
        .tabs-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-button {
            background-color: var(--panel-purple);
            color: var(--text-dim);
            border: 2px solid transparent;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tab-button:hover {
            background-color: #4a3a5a;
        }

        .tab-button.active {
            background-color: var(--accent-cyan);
            color: var(--bg-deep-purple);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* --- PANELES CON GRADIENTE --- */
        .indicators-panel, .decision-panel, .journal-panel, .chart-box, .news-panel, .profile-manager, .risk-tools-container {
            background: linear-gradient(135deg, #4A00E0, #E100FF);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1, h2, h3 {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 25px;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        h3 { font-size: 1.2em; margin-bottom: 15px; }

        /* --- ESTILOS DEL GESTOR DE PERFILES --- */
        .profile-manager {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            flex-wrap: wrap;
        }

        .profile-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-selector label {
            color: var(--text-light);
            font-weight: 600;
        }

        #profile-select {
            background-color: var(--item-purple);
            color: var(--text-light);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .profile-actions button {
            background-color: var(--accent-cyan);
            color: var(--bg-deep-purple);
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-actions button:hover {
            background-color: #ffffff;
            transform: scale(1.05);
        }
        
        .profile-actions button.delete-btn {
            background-color: var(--accent-magenta);
        }

        /* --- ESTILOS PARA LOS BOTONES DE CARGA Y DESCARGA --- */
        .profile-actions button#download-profiles-btn,
        .profile-actions button#upload-profiles-btn {
            width: 35px;
            height: 35px;
            padding: 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- ESTILOS DEL ASISTENTE --- */
        .indicator-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .indicator-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--accent-cyan);
            padding: 15px 20px;
            margin-bottom: 12px;
            border-radius: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        
        .indicator-item:hover {
            background-color: #00cccc;
            transform: translateY(-2px);
        }

        .label-text {
            flex-grow: 1;
            text-align: center;
            font-size: 16px;
            padding: 0 15px;
            font-weight: 600;
            color: #111;
        }

        .indicator-button {
            border: none;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }

        .btn-green { background-color: #1a4d2e; border: 2px solid #a0a0a0; }
        .btn-red { background-color: #4d1a1a; border: 2px solid #a0a0a0; }

        .btn-green.active {
            background-color: #4CAF50;
            box-shadow: 0 0 15px 5px rgba(76, 175, 80, 0.6),
                        0 0 25px 10px rgba(76, 175, 80, 0.4),
                        inset 0 0 10px rgba(255,255,255,0.2);
        }

        .btn-red.active {
            background-color: var(--accent-magenta);
            box-shadow: 0 0 15px 5px rgba(255, 0, 255, 0.6),
                        0 0 25px 10px rgba(255, 0, 255, 0.4),
                        inset 0 0 10px rgba(255,255,255,0.2);
        }

        /* --- ESTILOS PARA EL PESO DE LOS INDICADORES --- */
        .weight-input {
            width: 50px;
            padding: 5px;
            background-color: var(--item-purple);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-light);
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            margin: 0 10px;
        }

        .weight-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 5px var(--accent-cyan);
        }
        
        /* --- ESTILOS PARA EL BOTÓN DE ELIMINAR INDICADOR --- */
        .trash-icon-btn {
            cursor: pointer;
            color: purple;
            width: 20px;
            height: 20px;
            margin-left: 8px;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .trash-icon-btn:hover {
            color: #d32f2f;
            transform: scale(1.1);
        }
        .delete-indicator-btn:hover {
            background-color: #b71c1c;
        }

        /* ESTILOS DEL PANEL DE DECISIÓN */
        .decision-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }

        .decision-icons-container {
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            gap: 25px;
        }

        .decision-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        .decision-icon {
            width: 60px;
            height: 60px;
            fill: #555555;
            opacity: 0.3;
        }

        .decision-wait .decision-icon { opacity: 1; fill: var(--text-dim); }
        .decision-item.active .decision-icon { opacity: 1; transform: scale(1.1); }
        .decision-buy.active .decision-icon { fill: var(--accent-cyan); box-shadow: 0 0 20px 8px rgba(0, 255, 255, 0.6); }
        .decision-sell.active .decision-icon { fill: var(--accent-magenta); box-shadow: 0 0 20px 8px rgba(255, 0, 255, 0.6); }
        .decision-wait.active .decision-icon { fill: var(--accent-yellow); box-shadow: 0 0 20px 8px rgba(255, 193, 7, 0.6); }

        .decision-label { font-size: 14px; color: var(--text-dim); font-weight: 600; }

        .threshold-input {
            width: 60px;
            padding: 8px;
            background-color: var(--item-purple);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
        }
        .threshold-input:focus { outline: none; border-color: var(--accent-cyan); box-shadow: 0 0 5px var(--accent-cyan); }

        /* --- ESTILOS DE LA PESTAÑA G. RIESGO --- */
        .risk-tools-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .risk-tool {
            background-color: var(--item-purple);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .risk-tool h3 {
            color: var(--accent-cyan);
            margin-top: 0;
        }
        
        .risk-tool p {
            color: var(--text-dim);
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .risk-tool-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .risk-tool-table th, .risk-tool-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #8532d3ec;
        }
        
        .risk-tool-table th {
            background-color: #8532d3ec;
            color: var(--accent-cyan);
            font-weight: 600;
        }
        
        .risk-tool-table input {
            width: 100%;
            background-color: var(--bg-deep-purple);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            padding: 8px;
            border-radius: 6px;
            box-sizing: border-box;
            font-family: var(--font-main);
            font-size: 16px;
            text-align: center;
        }
        
        .risk-tool-table input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        
        .calculate-btn {
            background-color: var(--accent-cyan);
            color: var(--bg-deep-purple);
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        .calculate-btn:hover {
            background-color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
        }

        .result-display {
            background-color: #8532d3ec;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background-color: var(--bg-deep-purple);
            border-radius: 6px;
        }

        .result-item:last-child {
            margin-bottom: 0;
        }

        .result-label {
            color: var(--text-dim);
            font-weight: 600;
        }

        .result-value {
            color: var(--accent-cyan);
            font-weight: bold;
            font-size: 1.1em;
            transition: color 0.3s ease;
        }

        .result-value.warning {
            color: #ff4444;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* --- ESTILOS DEL REGISTRO --- */
        .journal-panel { max-height: 80vh; display: flex; flex-direction: column; }
        .journal-table-container { overflow-y: auto; flex-grow: 1; margin-bottom: 20px; }
        .journal-table { width: 100%; border-collapse: collapse; }
        .journal-table th, .journal-table td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .journal-table th { background-color: var(--accent-cyan); color: #111; font-weight: 600; position: sticky; top: 0; z-index: 1; }
        .journal-table input, .journal-table select, .journal-table textarea {
            width: 100%;
            background-color: var(--bg-deep-purple);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            padding: 8px;
            border-radius: 6px;
            box-sizing: border-box;
            font-family: var(--font-main);
            font-size: 16px;
        }
        .journal-table input[readonly] { background-color: #4a4a4a; cursor: default; color: var(--text-light); }
        .journal-table textarea { resize: vertical; min-height: 40px; }
        .journal-table input:focus, .journal-table select:focus, .journal-table textarea:focus { outline: none; border-color: var(--accent-cyan); }
        .journal-table td:nth-child(2) input { width: 12ch; min-width: 12ch; }
        .journal-table td:nth-child(4) input, .journal-table td:nth-child(5) input, .journal-table td:nth-child(6) input { width: 9ch; min-width: 9ch; }
        .journal-table td:nth-child(7) textarea { width: 25ch; min-width: 25ch; }
        input[type="number"] { -moz-appearance: textfield; }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .journal-table .roi-cell { font-weight: bold; }
        .journal-table .positive { color: #4CAF50; }
        .journal-table .negative { color: #f44336; }
        .delete-btn { background-color: #4d1a1a; color: var(--text-light); border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; transition: background-color 0.3s; font-weight: 600; }
        .delete-btn:hover { background-color: var(--accent-magenta); }
        .journal-actions { display: flex; gap: 15px; justify-content: space-between; }
        .add-trade-btn, .download-csv-btn { background-color: var(--accent-cyan); color: var(--bg-deep-purple); border: none; padding: 12px 20px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        .add-trade-btn { flex-grow: 1; }
        .download-csv-btn { padding: 10px 15px; font-size: 14px; flex-shrink: 0; }
        .add-trade-btn:hover, .download-csv-btn:hover { background-color: #ffffff; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4); }

        /* --- APLICAR ESPACIADO A LA PESTAÑA ASISTENTE --- */
        #asistente-tab.active { display: flex; flex-direction: column; align-items: center; gap: 30px; }

        /* --- MEDIA QUERY PARA MÓVILES --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .content-wrapper { max-width: 100%; }
            .indicators-panel, .decision-panel, .journal-panel, .chart-box, .news-panel { padding: 20px; }
            .indicator-button { width: 40px; height: 40px; }
            .decision-icon { width: 50px; height: 50px; }
            .threshold-input { width: 50px; font-size: 14px; }
            .charts-container, .additional-charts-container, .third-charts-container, .fourth-charts-container, .fifth-charts-container { flex-direction: column; }
            .news-header { flex-direction: column; }
            .news-title { padding-right: 0; margin-bottom: 8px; }
            .journal-table thead { display: none; }
            .journal-table, .journal-table tbody, .journal-table tr, .journal-table td { display: block; width: 100%; }
            .journal-table tr { margin-bottom: 15px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; padding: 10px; background-color: var(--item-purple); }
            .journal-table td { display: flex; align-items: center; margin-bottom: 10px; }
            .journal-table td:last-child { margin-bottom: 0; justify-content: center; }
            .journal-table td::before { content: attr(data-label); font-weight: bold; color: var(--text-dim); width: 120px; flex-shrink: 0; padding-right: 10px; text-align: left; }
            .journal-table td input, .journal-table td select, .journal-table td textarea { flex-grow: 1; }
            .journal-table td:last-child::before { display: none; }
            .journal-table td:last-child .delete-btn { flex-grow: 0; }
        }
        /* --- ESTILOS DE LA VENTANA MODAL DE BIENVENIDA --- */
.modal-overlay {
    display: flex; /* Lo mantenemos oculto por defecto con JS */
    justify-content: center;
    align-items: center;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(15, 12, 41, 0.85); /* Fondo semitransparente */
    z-index: 1000; /* Para que esté por encima de todo */
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

.modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background: linear-gradient(135deg, #4A00E0, #E100FF);
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.2);
    max-width: 500px;
    text-align: center;
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.modal-overlay.show .modal-content {
    transform: scale(1);
}

.modal-content h2 {
    color: var(--text-light);
    margin-bottom: 20px;
    font-size: 1.8em;
}

.modal-content p {
    color: var(--text-dim);
    line-height: 1.6;
    margin-bottom: 15px;
    font-size: 1em;
}

.modal-close-btn {
    background-color: var(--accent-cyan);
    color: var(--bg-deep-purple);
    border: none;
    padding: 12px 25px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 10px;
}

.modal-close-btn:hover {
    background-color: #ffffff;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
}
    </style>
</head>
<body>

    <!-- VENTANA MODAL DE BIENVENIDA -->
<div id="welcome-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>¡Bienvenido a BrujAPP!</h2>
        <p>
            Crea perfiles para diferentes estrategias o activos. Scalping, swinging, BTC, ETH, alta/baja volatilidad, etc.
        </p>
        <p>
            Gestiona tus trades, calcula tus gastos, gestiona tu riesgo, minimiza pérdidas y maximiza ganancias.
        </p>
        <button id="close-modal-btn" class="modal-close-btn">¡Entendido, empezar!</button>
    </div>
</div>

    <!-- CONTENEDOR DE PESTAÑAS -->
    <div class="tabs-container">
        <button class="tab-button active" data-tab-target="asistente-tab">BrujAPP</button>
        <button class="tab-button" data-tab-target="riesgo-tab">G. Riesgo</button>
        <button class="tab-button" data-tab-target="registro-tab">Registro</button>
    </div>

    <!-- CONTENEDOR DEL CONTENIDO DE LAS PESTAÑAS -->
    <div class="content-wrapper">
        
        <!-- PESTAÑA 1: BRUJAPP -->
        <div id="asistente-tab" class="tab-content active">
            <!-- Gestor de Perfiles -->
            <div class="profile-manager">
                <div class="profile-selector">
                    <label for="profile-select">Perfil Activo:</label>
                    <select id="profile-select">
                        <!-- Las opciones se cargarán con JavaScript -->
                    </select>
                </div>
                <div class="profile-actions">
                    <button id="new-profile-btn">Nuevo</button>
                    <button id="download-profiles-btn" title="Descargar perfiles">⬇</button>
                    <button id="upload-profiles-btn" title="Cargar perfiles">⬆</button>
                    <button id="delete-profile-btn">Eliminar</button>
                    <button id="rename-profile-btn">Renombrar</button>
                    <button id="add-indicator-btn">Añadir Indicador</button>
                </div>
            </div>
            
            <div class="indicators-panel">
                <h1>BrujAPP</h1>
                <ul class="indicator-list" id="indicator-list">
                    <!-- Los indicadores se cargarán dinámicamente con JavaScript -->
                </ul>
            </div>

           <!-- PANEL DE DECISIÓN -->
            <div class="decision-panel">
                <div class="decision-icons-container">
                    <div class="decision-item decision-buy" id="buy-signal">
                        <svg class="decision-icon" viewBox="0 0 24 24"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.85-1.26l3.03-7.08c.09-.23.12-.47.12-.66v-2z"/></svg>
                        <input type="number" class="threshold-input" id="green-threshold" value="40" min="1">
                        <span class="decision-label">LONG</span>
                    </div>
                    <div class="decision-item decision-wait active" id="wait-signal">
                        <svg class="decision-icon" viewBox="0 0 24 24"><path d="M6 2v6h.01L6 8.01 10 12l-4 4 .01.01H6V22h12v-5.99h-.01L18 16l-4-4 4-3.99-.01-.01H18V2H6z"/></svg>
                        <span class="decision-label">ESPERA</span>
                    </div>
                    <div class="decision-item decision-sell" id="sell-signal">
                        <svg class="decision-icon" viewBox="0 0 24 24"><path d="M15 3H6c-.83 0-1.54.5-1.85 1.26l-3.03 7.08c-.09.23-.12.47-.12.66v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/></svg>
                        <input type="number" class="threshold-input" id="red-threshold" value="40" min="1">
                        <span class="decision-label">SHORT</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- PESTAÑA 2: GESTIÓN DE RIESGO -->
        <div id="riesgo-tab" class="tab-content">
            <div class="risk-tools-container">
                <h2>Gestión de Riesgo</h2>
                
                <!-- Herramienta 1: Calculadora de Stop Loss y Take Profit -->
                <div class="risk-tool">
                    <h3>Calculadora de Stop Loss y Take Profit</h3>
                    <p>
                        Esta herramienta te ayuda a calcular el tamaño de tu posición, stop loss y take profit basado en tu capital total, apalancamiento y porcentaje de riesgo. 
                        Sigue estos pasos:
                    </p>
                    <ol>
                        <li>Introduce tu capital total y el apalancamiento que usarás</li>
                        <li>Ajusta el porcentaje de tu cuenta que estás dispuesto a arriesgar</li>
                        <li>Introduce los puntos del activo para calcular el número de contratos</li>
                        <li>Establece el valor de Stop Loss deseado</li>
                        <li>Configura tu Risk Reward Ratio y pérdida máxima deseada</li>
                        <li>La herramienta calculará automáticamente los valores necesarios</li>
                    </ol>
                    
                    <table class="risk-tool-table">
                        <thead>
                            <tr>
                                <th>Parámetro</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>CAPITAL TOTAL</td>
                                <td><input type="number" id="capital-total" value="1000" min="0"></td>
                            </tr>
                            <tr>
                                <td>APALANCAMIENTO</td>
                                <td><input type="number" id="apalancamiento" value="10" min="1"></td>
                            </tr>
                            <tr>
                                <td>% DE LA CUENTA</td>
                                <td><input type="number" id="porcentaje-cuenta" value="2" min="0" max="100" step="0.1"></td>
                            </tr>
                            <tr>
                                <td>PUNTOS</td>
                                <td><input type="number" id="puntos" value="100" min="0.01" step="0.01"></td>
                            </tr>
                            <tr>
                                <td>STOP LOSS (%)</td>
                                <td><input type="number" id="stop-loss" value="1" min="0" step="0.1"></td>
                            </tr>
                            <tr>
                                <td>RISK REWARD RATIO DESEADO</td>
                                <td><input type="number" id="risk-reward-ratio" value="3" min="1"></td>
                            </tr>
                            <tr>
                                <td>PÉRDIDA MÁXIMA DESEADA (%)</td>
                                <td><input type="number" id="perdida-maxima" value="2" min="0" step="0.1"></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="result-display">
                        <div class="result-item">
                            <span class="result-label">Capital:</span>
                            <span class="result-value" id="sl-tp-capital">$20.00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Contratos:</span>
                            <span class="result-value" id="sl-tp-contratos">2.00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Take Profit:</span>
                            <span class="result-value" id="sl-tp-tp">3.00%</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Pérdida ($):</span>
                            <span class="result-value" id="sl-tp-perdida-dolares">$200.00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">% Pérdida:</span>
                            <span class="result-value" id="sl-tp-perdida">20.00%</span>
                        </div>
                    </div>
                    
                    <button class="calculate-btn" id="calculate-sl-tp">Calcular</button>
                </div>
                
                <!-- Herramienta 2: Ratio de cobertura de comisiones -->
                <div class="risk-tool">
                    <h3>Ratio de cobertura de comisiones</h3>
                    <p>
                        Esta herramienta te ayuda a calcular cuánto necesitas ganar para cubrir las comisiones de trading. 
                        Las comisiones se cobran tanto al abrir como al cerrar una posición, por lo que el costo total es el doble de la comisión individual.
                    </p>
                    <p>
                        Introduce los valores para calcular el porcentaje necesario para cubrir las comisiones y el costo total en dólares.
                    </p>
                    
                    <table class="risk-tool-table">
                        <thead>
                            <tr>
                                <th>Parámetro</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>COMISIÓN (%)</td>
                                <td><input type="number" id="comision" value="0.6" min="0" step="0.1"></td>
                            </tr>
                            <tr>
                                <td>APALANCAMIENTO</td>
                                <td><input type="number" id="apalancamiento-comision" value="10" min="1"></td>
                            </tr>
                            <tr>
                                <td>CAPITAL ($)</td>
                                <td><input type="number" id="capital-comision" value="1000" min="0"></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="result-display">
                        <div class="result-item">
                            <span class="result-label">% para cubrir comisión:</span>
                            <span class="result-value" id="porcentaje-cubrir">1.20%</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Comisión ($):</span>
                            <span class="result-value" id="comision-dolares">$12.00</span>
                        </div>
                    </div>
                    
                    <button class="calculate-btn" id="calculate-comision">Calcular</button>
                </div>
            </div>
        </div>

        <!-- PESTAÑA 3: REGISTRO DE OPERACIONES -->
        <div id="registro-tab" class="tab-content">
            <div class="journal-panel">
                <h2>Registro de Operaciones</h2>
                <div class="journal-table-container">
                    <table class="journal-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Activo</th>
                                <th>Posición</th>
                                <th>Entrada</th>
                                <th>Salida</th>
                                <th>ROI (%)</th>
                                <th>Notas</th>
                                <th>Borrar</th>
                            </tr>
                        </thead>
                        <tbody id="journal-tbody">
                            <!-- Las filas se añadirán aquí con JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="journal-actions">
                    <button class="add-trade-btn" id="add-trade-btn">Añadir Operación</button>
                    <button class="download-csv-btn" id="download-csv-btn">Descargar CSV</button>
                </div>
            </div>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
    
    // --- LÓGICA DE LA VENTANA MODAL DE BIENVENIDA ---
const welcomeModal = document.getElementById('welcome-modal');
const closeModalBtn = document.getElementById('close-modal-btn');
const hasVisitedKey = 'hasVisitedBefore';

function showModal() {
    welcomeModal.classList.add('show');
}

function hideModal() {
    welcomeModal.classList.remove('show');
    // Marcamos que el usuario ya ha visitado la página
    localStorage.setItem(hasVisitedKey, 'true');
}

// Comprobamos si es la primera visita
if (!localStorage.getItem(hasVisitedKey)) {
    showModal();
}

// Event listener para el botón de cerrar
closeModalBtn.addEventListener('click', hideModal);

// Opcional: Cerrar la ventana haciendo clic fuera del contenido
welcomeModal.addEventListener('click', (event) => {
    if (event.target === welcomeModal) {
        hideModal();
    }
});

        // --- LÓGICA DEL SISTEMA DE PESTAÑAS ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                button.classList.add('active');
                const targetId = button.getAttribute('data-tab-target');
                const targetContent = document.getElementById(targetId);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            });
        });

        // --- LÓGICA DEL MOTOR DE ESTRATEGIAS ---
        const buySignal = document.getElementById('buy-signal');
        const waitSignal = document.getElementById('wait-signal');
        const sellSignal = document.getElementById('sell-signal');
        const greenThresholdInput = document.getElementById('green-threshold');
        const redThresholdInput = document.getElementById('red-threshold');
        const indicatorList = document.getElementById('indicator-list');

        // --- LÓGICA DE GESTIÓN DE PERFILES E INDICADORES ---
        const PROFILES_STORAGE_KEY = 'strategyProfiles';
        const DEFAULT_PROFILE_NAME = 'Perfil por Defecto';
        let currentProfileName = DEFAULT_PROFILE_NAME;
        let currentProfileData = {};

        const defaultIndicators = {
            "RSI (Sobreventa/Sobrecompra)": { state: null, weight: 10 },
            "RSI (Divergencia)": { state: null, weight: 10 },
            "MACD (Cruces)": { state: null, weight: 10 },
            "MACD (Divergencia)": { state: null, weight: 10 },
            "Soporte/Resistencia": { state: null, weight: 10 },
            "Tendencia (Mayor temporalidad)": { state: null, weight: 10 },
            "Patrones": { state: null, weight: 10 }
        };

        function initializeProfiles() {
            const profiles = JSON.parse(localStorage.getItem(PROFILES_STORAGE_KEY) || '{}');
            
            if (!profiles[DEFAULT_PROFILE_NAME]) {
                profiles[DEFAULT_PROFILE_NAME] = createDefaultProfile();
                localStorage.setItem(PROFILES_STORAGE_KEY, JSON.stringify(profiles));
            }
            
            updateProfileSelector();
            loadProfile(DEFAULT_PROFILE_NAME);
        }

        function createDefaultProfile() {
            return {
                indicators: { ...defaultIndicators },
                thresholds: { green: 40, red: 40 },
            };
        }

        function updateProfileSelector() {
            const profiles = JSON.parse(localStorage.getItem(PROFILES_STORAGE_KEY) || '{}');
            const profileSelect = document.getElementById('profile-select');
            profileSelect.innerHTML = '';
            
            Object.keys(profiles).forEach(profileName => {
                const option = document.createElement('option');
                option.value = profileName;
                option.textContent = profileName;
                if (profileName === currentProfileName) {
                    option.selected = true;
                }
                profileSelect.appendChild(option);
            });
        }

        function loadProfile(profileName) {
            const profiles = JSON.parse(localStorage.getItem(PROFILES_STORAGE_KEY) || '{}');
            
            if (!profiles[profileName]) {
                console.error(`El perfil "${profileName}" no existe.`);
                return;
            }
            
            currentProfileName = profileName;
            currentProfileData = JSON.parse(JSON.stringify(profiles[profileName]));
            
            greenThresholdInput.value = currentProfileData.thresholds.green;
            redThresholdInput.value = currentProfileData.thresholds.red;
            
            renderIndicators();
            updateDecision();
            
            console.log(`Perfil "${profileName}" cargado correctamente.`);
        }

        function saveProfile() {
            if (!currentProfileData || !currentProfileData.indicators) return;
            
            const profiles = JSON.parse(localStorage.getItem(PROFILES_STORAGE_KEY) || '{}');
            
            currentProfileData.thresholds = {
                green: parseInt(greenThresholdInput.value) || 40,
                red: parseInt(redThresholdInput.value) || 40
            };

            const indicatorItems = document.querySelectorAll('.indicator-item');
            indicatorItems.forEach(item => {
                const indicatorName = item.dataset.indicatorName;
                const greenButton = item.querySelector('.btn-green');
                const redButton = item.querySelector('.btn-red');
                const weightInput = item.querySelector('.weight-input');

                if (currentProfileData.indicators[indicatorName]) {
                    if (greenButton.classList.contains('active')) {
                        currentProfileData.indicators[indicatorName].state = 'green';
                    } else if (redButton.classList.contains('active')) {
                        currentProfileData.indicators[indicatorName].state = 'red';
                    } else {
                        currentProfileData.indicators[indicatorName].state = null;
                    }
                    currentProfileData.indicators[indicatorName].weight = parseInt(weightInput.value) || 10;
                }
            });

            profiles[currentProfileName] = currentProfileData;
            localStorage.setItem(PROFILES_STORAGE_KEY, JSON.stringify(profiles));
            console.log(`Perfil "${currentProfileName}" guardado correctamente.`);
        }

        function renderIndicators() {
            indicatorList.innerHTML = '';

            if (!currentProfileData || !currentProfileData.indicators) {
                indicatorList.innerHTML = '<p style="text-align:center; color:var(--text-dim);">No hay indicadores en este perfil.</p>';
                return;
            }

            Object.keys(currentProfileData.indicators).forEach(name => {
                const indicator = currentProfileData.indicators[name];
                const li = document.createElement('li');
                li.className = 'indicator-item';
                li.dataset.indicatorName = name;

                li.innerHTML = `
                    <button class="indicator-button btn-green" data-state="green"></button>
                    <input type="number" class="weight-input" value="${indicator.weight}" min="0" max="99">
                    <svg class="trash-icon-btn" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" title="Eliminar indicador">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                    <span class="label-text">${name}</span>
                    <button class="indicator-button btn-red" data-state="red"></button>
                `;

                if (indicator.state === 'green') {
                    li.querySelector('.btn-green').classList.add('active');
                } else if (indicator.state === 'red') {
                    li.querySelector('.btn-red').classList.add('active');
                }
                
                indicatorList.appendChild(li);
            });
        }
        
        function addNewIndicator() {
            const name = prompt('Introduce el nombre del nuevo indicador:');
            if (!name || !name.trim()) return;

            const trimmedName = name.trim();
            if (currentProfileData.indicators.hasOwnProperty(trimmedName)) {
                alert('Ya existe un indicador con ese nombre.');
                return;
            }

            currentProfileData.indicators[trimmedName] = { state: null, weight: 10 };
            saveProfile();
            renderIndicators();
            updateDecision();
            console.log(`Indicador "${trimmedName}" añadido.`);
        }

        function deleteIndicator(indicatorName) {
            if (!confirm(`¿Estás seguro de que quieres eliminar el indicador "${indicatorName}"?`)) {
                return;
            }
            delete currentProfileData.indicators[indicatorName];
            saveProfile();
            renderIndicators();
            updateDecision();
            console.log(`Indicador "${indicatorName}" eliminado.`);
        }

        function createNewProfile() {
            const profileName = prompt('Introduce un nombre para el nuevo perfil:');
            if (!profileName || !profileName.trim()) return;
            
            const profiles = JSON.parse(localStorage.getItem(PROFILES_STORAGE_KEY) || '{}');
            if (profiles[profileName]) {
                alert('Ya existe un perfil con ese nombre.');
                return;
            }
            
            saveProfile();
            profiles[profileName] = createDefaultProfile();
            localStorage.setItem(PROFILES_STORAGE_KEY, JSON.stringify(profiles));
            
            updateProfileSelector();
            loadProfile(profileName);
        }

        function deleteCurrentProfile() {
            if (currentProfileName === DEFAULT_PROFILE_NAME) {
                alert('No se puede eliminar el perfil por defecto.');
                return;
            }
            if (!confirm(`¿Estás seguro de que quieres eliminar el perfil "${currentProfileName}"?`)) return;
            
            const profiles = JSON.parse(localStorage.getItem(PROFILES_STORAGE_KEY) || '{}');
            delete profiles[currentProfileName];
            localStorage.setItem(PROFILES_STORAGE_KEY, JSON.stringify(profiles));
            
            currentProfileName = DEFAULT_PROFILE_NAME;
            updateProfileSelector();
            loadProfile(currentProfileName);
        }

        function renameCurrentProfile() {
            const newName = prompt('Introduce un nuevo nombre para el perfil:', currentProfileName);
            if (!newName || !newName.trim() || newName === currentProfileName) return;
            
            const profiles = JSON.parse(localStorage.getItem(PROFILES_STORAGE_KEY) || '{}');
            if (profiles[newName]) {
                alert('Ya existe un perfil con ese nombre.');
                return;
            }
            
            profiles[newName] = profiles[currentProfileName];
            delete profiles[currentProfileName];
            currentProfileName = newName;
            localStorage.setItem(PROFILES_STORAGE_KEY, JSON.stringify(profiles));
            
            updateProfileSelector();
        }

        // Función para descargar perfiles
        function downloadProfiles() {
            const profiles = JSON.parse(localStorage.getItem(PROFILES_STORAGE_KEY) || '{}');
            const dataStr = JSON.stringify(profiles, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'brujapp_profiles.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Función para cargar perfiles
        function uploadProfiles(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const profiles = JSON.parse(e.target.result);
                    localStorage.setItem(PROFILES_STORAGE_KEY, JSON.stringify(profiles));
                    updateProfileSelector();
                    loadProfile(currentProfileName);
                    alert('Perfiles cargados correctamente');
                } catch (error) {
                    alert('Error al cargar los perfiles: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Event Listeners para gestión de perfiles
        document.getElementById('new-profile-btn').addEventListener('click', createNewProfile);
        document.getElementById('delete-profile-btn').addEventListener('click', deleteCurrentProfile);
        document.getElementById('rename-profile-btn').addEventListener('click', renameCurrentProfile);
        document.getElementById('add-indicator-btn').addEventListener('click', addNewIndicator);
        document.getElementById('profile-select').addEventListener('change', (e) => {
            saveProfile();
            loadProfile(e.target.value);
        });

        // Event listeners para los nuevos botones
        document.getElementById('download-profiles-btn').addEventListener('click', downloadProfiles);

        // Para el botón de carga, necesitamos crear un input de archivo oculto
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        fileInput.style.display = 'none';
        fileInput.addEventListener('change', uploadProfiles);
        document.body.appendChild(fileInput);

        document.getElementById('upload-profiles-btn').addEventListener('click', () => {
            fileInput.click();
        });

        // Event Delegation para la lista de indicadores
        indicatorList.addEventListener('click', (event) => {
            const item = event.target.closest('.indicator-item');
            if (!item) return;

            const indicatorName = item.dataset.indicatorName;
            const indicatorData = currentProfileData.indicators[indicatorName];
            if (!indicatorData) return;

            if (event.target.classList.contains('indicator-button')) {
                const wasActive = event.target.classList.contains('active');
                const allButtons = item.querySelectorAll('.indicator-button');
                allButtons.forEach(btn => btn.classList.remove('active'));
                
                if (!wasActive) {
                    event.target.classList.add('active');
                    indicatorData.state = event.target.dataset.state;
                } else {
                    indicatorData.state = null;
                }
                
                saveProfile();
                updateDecision();
            } 
            else if (event.target.closest('.trash-icon-btn')) {
                deleteIndicator(indicatorName);
            }
        });

        indicatorList.addEventListener('input', (event) => {
            if (event.target.classList.contains('weight-input')) {
                const item = event.target.closest('.indicator-item');
                const indicatorName = item.dataset.indicatorName;
                if (currentProfileData.indicators[indicatorName]) {
                    currentProfileData.indicators[indicatorName].weight = parseInt(event.target.value) || 10;
                    
                    saveProfile();
                    updateDecision();
                }
            }
        });

        greenThresholdInput.addEventListener('input', () => {
            saveProfile();
            updateDecision();
        });

        redThresholdInput.addEventListener('input', () => {
            saveProfile();
            updateDecision();
        });

        function updateDecision() {
            if (!currentProfileData || !currentProfileData.indicators) {
                waitSignal.classList.add('active');
                buySignal.classList.remove('active');
                sellSignal.classList.remove('active');
                return;
            }

            let totalGreenWeight = 0;
            let totalRedWeight = 0;

            Object.keys(currentProfileData.indicators).forEach(name => {
                const indicator = currentProfileData.indicators[name];
                if (indicator.state === 'green') {
                    totalGreenWeight += indicator.weight || 0;
                } else if (indicator.state === 'red') {
                    totalRedWeight += indicator.weight || 0;
                }
            });

            const greenThreshold = parseInt(greenThresholdInput.value) || 0;
            const redThreshold = parseInt(redThresholdInput.value) || 0;

            buySignal.classList.remove('active');
            sellSignal.classList.remove('active');
            waitSignal.classList.remove('active');

            if (totalGreenWeight > totalRedWeight && totalGreenWeight >= greenThreshold) {
                buySignal.classList.add('active');
            } else if (totalRedWeight > totalGreenWeight && totalRedWeight >= redThreshold) {
                sellSignal.classList.add('active');
            } else {
                waitSignal.classList.add('active');
            }
        }

        // --- LÓGICA DE GESTIÓN DE RIESGO ---
        const calculateSLTPBtn = document.getElementById('calculate-sl-tp');
        const calculateComisionBtn = document.getElementById('calculate-comision');

        calculateSLTPBtn.addEventListener('click', () => {
            const capital = parseFloat(document.getElementById('capital-total').value) || 0;
            const apalancamiento = parseFloat(document.getElementById('apalancamiento').value) || 1;
            const porcentajeCuenta = parseFloat(document.getElementById('porcentaje-cuenta').value) || 0;
            const puntos = parseFloat(document.getElementById('puntos').value) || 0;
            const stopLoss = parseFloat(document.getElementById('stop-loss').value) || 0;
            const riskRewardRatio = parseFloat(document.getElementById('risk-reward-ratio').value) || 1;
            const perdidaMaxima = parseFloat(document.getElementById('perdida-maxima').value) || 0;

            const capitalRiesgo = capital * (porcentajeCuenta / 100);
            const capitalApalancado = capital * apalancamiento;
            const contratos = (capitalRiesgo / 100) / (puntos * stopLoss / 100);
            const takeProfit = stopLoss * riskRewardRatio;
            const perdidaDolares = contratos * puntos * stopLoss;
            const perdidaPorcentaje = (perdidaDolares / capitalApalancado) * 100;

            document.getElementById('sl-tp-capital').textContent = `$${capitalRiesgo.toFixed(2)}`;
            document.getElementById('sl-tp-contratos').textContent = contratos.toFixed(2);
            document.getElementById('sl-tp-tp').textContent = `${takeProfit.toFixed(2)}%`;
            document.getElementById('sl-tp-perdida-dolares').textContent = `$${perdidaDolares.toFixed(2)}`;
            document.getElementById('sl-tp-perdida').textContent = `${perdidaPorcentaje.toFixed(2)}%`;

            if (perdidaPorcentaje > perdidaMaxima) {
                document.getElementById('sl-tp-perdida').classList.add('warning');
            } else {
                document.getElementById('sl-tp-perdida').classList.remove('warning');
            }
        });

        calculateComisionBtn.addEventListener('click', () => {
            const comision = parseFloat(document.getElementById('comision').value) || 0;
            const apalancamiento = parseFloat(document.getElementById('apalancamiento-comision').value) || 1;
            const capital = parseFloat(document.getElementById('capital-comision').value) || 0;

            const comisionTotal = comision * 2; // Comisión al abrir y cerrar
            const porcentajeCubrir = comisionTotal / apalancamiento;
            const comisionDolares = capital * (comisionTotal / 100);

            document.getElementById('porcentaje-cubrir').textContent = `${porcentajeCubrir.toFixed(2)}%`;
            document.getElementById('comision-dolares').textContent = `$${comisionDolares.toFixed(2)}`;
        });

        // --- LÓGICA DEL REGISTRO DE OPERACIONES ---
        const journalTbody = document.getElementById('journal-tbody');
        const addTradeBtn = document.getElementById('add-trade-btn');
        const downloadCSBtn = document.getElementById('download-csv-btn');
        const JOURNAL_STORAGE_KEY = 'tradingJournal';

        function loadJournal() {
            const journal = JSON.parse(localStorage.getItem(JOURNAL_STORAGE_KEY) || '[]');
            journalTbody.innerHTML = '';
            
            journal.forEach((trade, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="date" value="${trade.date}" data-index="${index}" data-field="date"></td>
                    <td><input type="text" value="${trade.asset}" data-index="${index}" data-field="asset"></td>
                    <td>
                        <select data-index="${index}" data-field="position">
                            <option value="LONG" ${trade.position === 'LONG' ? 'selected' : ''}>LONG</option>
                            <option value="SHORT" ${trade.position === 'SHORT' ? 'selected' : ''}>SHORT</option>
                        </select>
                    </td>
                    <td><input type="number" value="${trade.entry}" data-index="${index}" data-field="entry"></td>
                    <td><input type="number" value="${trade.exit}" data-index="${index}" data-field="exit"></td>
                    <td class="roi-cell ${trade.roi >= 0 ? 'positive' : 'negative'}">${trade.roi.toFixed(2)}%</td>
                    <td><textarea data-index="${index}" data-field="notes">${trade.notes}</textarea></td>
                    <td><button class="delete-btn" data-index="${index}">Borrar</button></td>
                `;
                journalTbody.appendChild(row);
            });
        }

        function saveJournal() {
            const journal = [];
            const rows = journalTbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input, select, textarea');
                const trade = {
                    date: inputs[0].value,
                    asset: inputs[1].value,
                    position: inputs[2].value,
                    entry: parseFloat(inputs[3].value) || 0,
                    exit: parseFloat(inputs[4].value) || 0,
                    roi: 0,
                    notes: inputs[5].value
                };
                
                // Calcular ROI
                if (trade.entry > 0 && trade.exit > 0) {
                    if (trade.position === 'LONG') {
                        trade.roi = ((trade.exit - trade.entry) / trade.entry) * 100;
                    } else {
                        trade.roi = ((trade.entry - trade.exit) / trade.entry) * 100;
                    }
                }
                
                journal.push(trade);
            });
            
            localStorage.setItem(JOURNAL_STORAGE_KEY, JSON.stringify(journal));
            loadJournal();
        }

        function addTrade() {
            const newTrade = {
                date: new Date().toISOString().split('T')[0],
                asset: '',
                position: 'LONG',
                entry: 0,
                exit: 0,
                roi: 0,
                notes: ''
            };
            
            const journal = JSON.parse(localStorage.getItem(JOURNAL_STORAGE_KEY) || '[]');
            journal.push(newTrade);
            localStorage.setItem(JOURNAL_STORAGE_KEY, JSON.stringify(journal));
            loadJournal();
        }

        function deleteTrade(index) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta operación?')) return;
            
            const journal = JSON.parse(localStorage.getItem(JOURNAL_STORAGE_KEY) || '[]');
            journal.splice(index, 1);
            localStorage.setItem(JOURNAL_STORAGE_KEY, JSON.stringify(journal));
            loadJournal();
        }

        function downloadCSV() {
            const journal = JSON.parse(localStorage.getItem(JOURNAL_STORAGE_KEY) || '[]');
            
            let csv = 'Fecha,Activo,Posición,Entrada,Salida,ROI (%),Notas\n';
            journal.forEach(trade => {
                csv += `${trade.date},${trade.asset},${trade.position},${trade.entry},${trade.exit},${trade.roi.toFixed(2)},"${trade.notes}"\n`;
            });
            
            const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            const exportFileDefaultName = 'trading_journal.csv';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        addTradeBtn.addEventListener('click', addTrade);
        downloadCSBtn.addEventListener('click', downloadCSV);

        journalTbody.addEventListener('input', (e) => {
            if (e.target.matches('input, select, textarea')) {
                saveJournal();
            }
        });

        journalTbody.addEventListener('click', (e) => {
            if (e.target.matches('.delete-btn')) {
                const index = parseInt(e.target.dataset.index);
                deleteTrade(index);
            }
        });

        // Inicialización
        initializeProfiles();
        loadJournal();
    });
    </script>
</body>
</html>
